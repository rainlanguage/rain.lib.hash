<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>LibHashNoAlloc</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../book.css">

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../../index.html">Home</a></li><li class="chapter-item affix "><li class="part-title">src</li><li class="chapter-item expanded "><a href="../../src/LibHashNoAlloc.sol/library.LibHashNoAlloc.html" class="active">LibHashNoAlloc</a></li><li class="chapter-item "><a href="../../src/LibHashNoAlloc.sol/constants.LibHashNoAlloc.html">LibHashNoAlloc constants</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rainprotocol/rain.lib.hash" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="libhashnoalloc"><a class="header" href="#libhashnoalloc">LibHashNoAlloc</a></h1>
<p><a href="https://github.com/rainprotocol/rain.lib.hash/blob/59c3ded1c19740d4551facfb857c9e8ca88a19df/src/LibHashNoAlloc.sol">Git Source</a></p>
<p>When producing hashes of just about anything that isn't already bytes
the common suggestions look something like <code>keccak256(abi.encode(...))</code> or
<code>keccak256(abi.encodePacked(...))</code> with the main differentiation being
whether dynamic data types are being hashed. If they are then there is a hash
collision risk in the packed case as <code>&quot;abc&quot; + &quot;def&quot;</code> and <code>&quot;ab&quot; + &quot;cdef&quot;</code> will
pack and therefore hash to the same values, the suggested fix commonly being
to use abi.encode, which includes the lengths disambiguating dynamic data.
Something like <code>3&quot;abc&quot; + 3&quot;def&quot;</code> with the length prefixes won't collide with
<code>2&quot;ab&quot; + 4&quot;cdef&quot;</code> but note that ABI provides neither a strong guarantee to
be collision resitant on inputs (as far as I know, it's a coincidence that
this works), nor an efficient solution.</p>
<ul>
<li>Abi encoding is a complex algorithm that is easily 1k+ gas for simple
structs with just one or two dynamic typed fields.</li>
<li>Abi encoding requires allocating and copying all the data plus a header to
a new region of memory, which gives it non-linearly increasing costs due to
memory expansion.</li>
<li>Abi encoding can't easily be reproduced offchain without specialised tools,
it's not simply a matter of length prefixing some byte string and hashing
with keccak256, the heads and tails all need to be produced recursively
https://docs.soliditylang.org/en/develop/abi-spec.html#formal-specification-of-the-encoding
Consider that <code>hash(hash(&quot;abc&quot;) + hash(&quot;def&quot;))</code> won't collide with
<code>hash(hash(&quot;ab&quot;) + hash(&quot;cdef&quot;))</code>. It should be easier to convince ourselves
this is true for all possible pairs of byte strings than it is to convince
ourselves that the ABI serialization is never ambigious. Inductively we can
scale this to all possible data structures that are ordered compositions of
byte strings. Even better, the native behaviour of <code>keccak256</code> in the EVM
requires no additional allocation of memory. Worst case scenario is that we
want to hash several hashes together like <code>hash(hash0, hash1, ...)</code>, in which
case we can write the words after the free memory pointer, hash them, but
leave the pointer. This way we pay for memory expansion but can re-use that
region of memory for subsequent logic, which may effectively make the
expansion free as we would have needed to pay for it anyway. Given that hash
checks often occur early in real world logic due to
checks-effects-interactions, this is not an unreasonable assumption to call
this kind of expansion &quot;no alloc&quot;.
One problem is that the gas saving for trivial abi encoding,
e.g. ~1-3 uint256 values, can be lost by the overhead of jumps and stack
manipulation due to function calls.</li>
</ul>
<pre><code>struct Foo {
uint256 a;
address b;
uint32 c;
}
</code></pre>
<p>The simplest way to hash <code>Foo</code> is to just hash it (crazy, i know!).</p>
<pre><code>assembly (&quot;memory-safe&quot;) {
hash_ := keccak256(foo_, 0x60)
}
</code></pre>
<p>Every struct field is 0x20 bytes in memory so 3 fields = 0x60 bytes to hash
always, with the exception of dynamic types. This costs about 70 gas vs.
about 350 gas for an abi encoding based approach.</p>
<h2 id="functions"><a class="header" href="#functions">Functions</a></h2>
<h3 id="hashbytes"><a class="header" href="#hashbytes">hashBytes</a></h3>
<pre><code class="language-solidity">function hashBytes(bytes memory data_) internal pure returns (bytes32 hash_);
</code></pre>
<h3 id="hashwords"><a class="header" href="#hashwords">hashWords</a></h3>
<pre><code class="language-solidity">function hashWords(bytes32[] memory words_) internal pure returns (bytes32 hash_);
</code></pre>
<h3 id="hashwords-1"><a class="header" href="#hashwords-1">hashWords</a></h3>
<pre><code class="language-solidity">function hashWords(uint256[] memory words_) internal pure returns (bytes32 hash_);
</code></pre>
<h3 id="combinehashes"><a class="header" href="#combinehashes">combineHashes</a></h3>
<pre><code class="language-solidity">function combineHashes(bytes32 a_, bytes32 b_) internal pure returns (bytes32 hash_);
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../src/LibHashNoAlloc.sol/constants.LibHashNoAlloc.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../src/LibHashNoAlloc.sol/constants.LibHashNoAlloc.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../solidity.min.js"></script>


    </div>
    </body>
</html>
